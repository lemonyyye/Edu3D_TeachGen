<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>水分子 3D 结构 (可导出 glTF) - Three.js</title>
    <!-- 引入 Three.js 库 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <!-- 引入轨道控制器 -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <!-- 关键：引入 GLTFExporter -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/exporters/GLTFExporter.js"></script>
    <!-- 引入 FileSaver.js 用于在浏览器中触发文件下载 -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

    <style>
        /* (样式部分与之前相同，此处省略) */
        body {
            margin: 0;
            overflow: hidden;
            background-color: #000;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        #container {
            width: 100vw;
            height: 100vh;
        }

        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            z-index: 100;
            display: block;
            font-size: 1.2em;
            text-shadow: 0 0 10px #000;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            background: rgba(40, 40, 40, 0.85);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(5px);
        }

        #controls button {
            background: #444;
            color: #eee;
            border: none;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s ease-in-out;
        }

        #controls button:hover {
            background: #666;
            color: #fff;
            transform: translateY(-2px);
        }
    </style>
</head>

<body>

    <div id="container"></div>
    <div id="info">H₂O 水分子 3D 结构 (支持导出 glTF)</div>
    <div id="controls">
        <button id="resetView">重置视角</button>
        <button id="toggleRotation">暂停旋转</button>
        <button id="zoomIn">放大</button>
        <button id="zoomOut">缩小</button>
        <!-- 新增：导出按钮 -->
        <button id="exportGltf">导出 glTF</button>
    </div>

    <script>
        // (初始化场景、相机、渲染器、控制器、光源的代码与之前相同，此处省略)
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 3, 8);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true; // 开启阴影渲染
        document.getElementById('container').appendChild(renderer.domElement);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 3;
        controls.maxDistance = 20;
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7.5);
        directionalLight.castShadow = true;
        scene.add(directionalLight);
        const pointLight = new THREE.PointLight(0x00ffff, 0.3, 100);
        pointLight.position.set(-5, -5, 5);
        scene.add(pointLight);

        const atomRadius = { O: 0.8, H: 0.5 };
        const atomColor = { O: 0xff4444, H: 0xffffff };

        // (createAtom 和 createWaterMolecule 函数与之前相同，此处省略)
        function createAtom(radius, color) {
            const geometry = new THREE.SphereGeometry(radius, 32, 32);
            const material = new THREE.MeshPhongMaterial({
                color: color,
                shininess: 80,
                specular: 0x222222
            });
            const atom = new THREE.Mesh(geometry, material);
            atom.castShadow = true;
            atom.receiveShadow = true;
            return atom;
        }

        function createWaterMolecule() {
            const moleculeGroup = new THREE.Group();
            moleculeGroup.name = "WaterMolecule"; // 给模型起个名字，会被导出到glTF中

            const oxygenGeometry = new THREE.SphereGeometry(atomRadius.O, 32, 32);
            const oxygenMaterial = new THREE.MeshPhongMaterial({
                color: atomColor.O,
                shininess: 100,
                specular: 0x333333
            });
            const oxygenAtom = new THREE.Mesh(oxygenGeometry, oxygenMaterial);
            oxygenAtom.name = "Oxygen";
            oxygenAtom.castShadow = true;
            oxygenAtom.receiveShadow = true;
            moleculeGroup.add(oxygenAtom);

            const hDistance = 2.0;
            const angle = Math.PI / 3;

            const hydrogen1 = createAtom(atomRadius.H, atomColor.H);
            hydrogen1.name = "Hydrogen1";
            hydrogen1.position.set(-hDistance * Math.sin(angle / 2), 0, hDistance * Math.cos(angle / 2));
            moleculeGroup.add(hydrogen1);

            const hydrogen2 = createAtom(atomRadius.H, atomColor.H);
            hydrogen2.name = "Hydrogen2";
            hydrogen2.position.set(hDistance * Math.sin(angle / 2), 0, -hDistance * Math.cos(angle / 2));
            moleculeGroup.add(hydrogen2);

            const bondGeometry = new THREE.CylinderGeometry(0.1, 0.1, hDistance, 12);
            const bondMaterial = new THREE.MeshPhongMaterial({
                color: 0xaaaaaa,
                shininess: 50
            });

            const bond1 = new THREE.Mesh(bondGeometry, bondMaterial);
            bond1.name = "Bond1";
            bond1.position.copy(hydrogen1.position.clone().lerp(oxygenAtom.position, 0.5));
            bond1.lookAt(oxygenAtom.position);
            bond1.rotateX(Math.PI / 2);
            moleculeGroup.add(bond1);

            const bond2 = new THREE.Mesh(bondGeometry, bondMaterial);
            bond2.name = "Bond2";
            bond2.position.copy(hydrogen2.position.clone().lerp(oxygenAtom.position, 0.5));
            bond2.lookAt(oxygenAtom.position);
            bond2.rotateX(Math.PI / 2);
            moleculeGroup.add(bond2);

            scene.add(moleculeGroup);
            return moleculeGroup;
        }

        const waterMolecule = createWaterMolecule();
        let isRotating = true;

        // (窗口大小自适应和动画循环的代码与之前相同，此处省略)
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        function animate() {
            requestAnimationFrame(animate);
            if (isRotating) {
                waterMolecule.rotation.y += 0.005;
                waterMolecule.rotation.x += 0.003;
            }
            controls.update();
            renderer.render(scene, camera);
        }

        // (按钮事件绑定与之前相同)
        document.getElementById('resetView').addEventListener('click', () => {
            camera.position.set(0, 3, 8);
            controls.reset();
        });

        document.getElementById('toggleRotation').addEventListener('click', (e) => {
            isRotating = !isRotating;
            e.target.textContent = isRotating ? '暂停旋转' : '开始旋转';
        });

        document.getElementById('zoomIn').addEventListener('click', () => {
            camera.position.multiplyScalar(0.9);
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            camera.position.multiplyScalar(1.1);
        });

        // ==================== 新增的导出逻辑 ====================
        document.getElementById('exportGltf').addEventListener('click', () => {
            // 1. 创建一个 GLTFExporter 实例
            const exporter = new THREE.GLTFExporter();

            // 2. 定义导出选项
            const options = {
                trs: true, // 导出位移、旋转、缩放信息（而不是矩阵）
                onlyVisible: true, // 只导出可见的对象
                binary: false, // 如果为 true，则导出 .glb 文件 (二进制)；false 则导出 .gltf (JSON)
                maxTextureSize: 4096 // 限制纹理大小
            };

            // 3. 执行导出
            // 注意：我们导出的是整个 scene，你也可以只导出 waterMolecule 这个 Group
            exporter.parse(scene, function (result) {
                // 导出成功后的回调函数

                if (options.binary) {
                    // 如果是二进制 .glb
                    const blob = new Blob([result], { type: 'application/octet-stream' });
                    saveAs(blob, 'water_molecule.glb');
                } else {
                    // 如果是 JSON 格式的 .gltf
                    const output = JSON.stringify(result, null, 2);
                    const blob = new Blob([output], { type: 'application/json' });
                    saveAs(blob, 'water_molecule.gltf');
                }

                console.log('glTF 文件已成功生成并触发下载。');

            }, function (error) {
                // 导出失败后的回调函数
                console.error('导出 glTF 文件时出错:', error);
            }, options);
        });

        animate();
    </script>

</body>

</html>